# 21点（Blackjack）插件开发文档

- **名称**：`21点`
- **作者**：`Desom-fu`
- **版本**：`1.0.0`
- **兼容版本**：`理论兼容所有 3.0 以上的 OlivOS 版本`
- **平台**：`理论支持能够私聊的全平台（仅在 QQ 部署测试）`
- **前置插件**：`OlivaDiceCore`

---

## 一、插件架构说明

### 1.1 文件结构

```
Blackjack/
├── __init__.py          # 插件入口，导出模块
├── main.py              # 事件处理器（Event类）
├── msgReply.py          # 消息回复处理（核心命令逻辑）
├── msgCustom.py         # 消息模板定义
├── msgCustomManager.py  # 消息模板管理器
├── function.py          # 游戏核心逻辑函数
├── app.json             # 插件配置文件
└── Blackjack.opk        # 插件包
```

### 1.2 架构设计

插件采用与TexasHoldem相同的架构模式：
- **msgReply.py**: 处理所有用户指令，调用function.py中的函数
- **function.py**: 实现游戏核心逻辑（发牌、计分、结算等）
- **msgCustom.py**: 定义所有用户可见的文本模板
- **main.py**: OlivOS事件路由，将事件转发到msgReply.py

---

## 二、数据结构设计

### 2.1 游戏状态数据结构（function.py中的blackjack_default）

```python
def blackjack_default() -> dict:
    return {
        'version': 1,
        'state': 'idle',  # idle（空闲）| waiting（等待开局）| playing（游戏中）| ended（已结束）
        'base_stake': 100,  # 基础下注额（默认100筹码）
        'min_stake': 10,    # 最小下注额
        'max_stake': 10000, # 最大下注额
        
        'game_mode': 'open',  # open（明牌局）| hidden（手持局）
        # open: 只有庄家发暗牌，玩家手牌公开
        # hidden: 玩家手牌也是暗牌，不自动检测21点
        
        'players': [],      # 玩家列表（list[Player]）
        'join_order': [],   # 按加入顺序记录 seat_id
        'dealer_seat_id': None,  # 庄家座位号（第一个加入的玩家为庄家）
        
        # 当前局状态
        'round_no': 0,      # 当前局数
        'dealer_cards': [], # 庄家手牌（最后一张暗牌）
        'deck': [],         # 牌堆（四副牌，共208张）
        
        'user_nicknames': {},  # 用户自定义昵称字典 {user_id: nickname}
    }
```

### 2.2 玩家数据结构（Player）

```python
# players列表中的每个玩家对象
{
    'seat_id': 1,           # 座位号（1-10）
    'user_id': '123456',    # 用户ID
    'nickname': '玩家A',    # 玩家昵称
    'chips': 1000,          # 玩家筹码
    'is_dealer': False,     # 是否为庄家
    'status': 'active',     # active（进行中）| stand（已停牌）| bust（爆牌）| blackjack（21点）| out（已出局）
    'hand_cards': [],       # 手牌列表
    'current_bet': 0,       # 当前下注额（21点主注）
    'insurance_bet': 0,     # 保险下注额（当庄家明牌为A时可购买）
    'bet_21_3': 0,          # 21+3投注额
    'bet_21_3_type': None,  # 21+3投注类型：'straight'（顺）/ 'flush'（同花）/ 'three_kind'（三条）/ 'straight_flush'（同花顺）/ 'flush_three'（同花三条）
    'hand_value': 0,        # 手牌点数（A按11计算，超过21时按1计算）
    'hand_value_soft': 0,   # 软点数（A按11计算）
    'hand_value_hard': 0,   # 硬点数（A按1计算）
    'hand_value_display': '', # 点数显示（如 "7/18" 表示软7硬18）
    'can_double': True,     # 是否可以双倍下注（仅第一次要牌时）
    'can_split': False,     # 是否可以分牌（手牌两张且点数相同）
    'can_surrender': True,  # 是否可以投降（仅第一次行动）
    'can_insurance': False, # 是否可以购买保险（庄家明牌为A时）
    'is_split': False,      # 是否已分牌
    'split_hands': [],      # 分牌后的多手牌（如果分牌）
    'last_action': '',      # 最后一次动作（hit/stand/double/split/surrender/insurance）
}
```

---

## 三、核心函数设计（function.py）

### 3.1 数据持久化

**数据文件路径结构**：
- 总路径：`plugin/data/BlackJack`
- 玩家数据：`plugin/data/BlackJack/user/{user_hash}.json`
- 群组数据：`plugin/data/BlackJack/group/{group_hash}.json`

```python
def get_blackjack_data_path() -> str:
    """获取数据存储总路径：plugin/data/BlackJack"""
    pass

def get_user_file_path(user_hash: str) -> str:
    """获取玩家数据文件路径：plugin/data/BlackJack/user/{user_hash}.json"""
    pass

def get_group_file_path(group_hash: str) -> str:
    """获取群组数据文件路径：plugin/data/BlackJack/group/{group_hash}.json"""
    pass

def load_group_data(group_hash: str) -> dict:
    """加载群组游戏数据"""
    pass

def save_group_data(group_hash: str, data: dict) -> None:
    """保存群组游戏数据"""
    pass

def load_user_data(user_hash: str) -> dict:
    """加载玩家数据
    返回: {
        'default_chips': 1000,  # 默认入局筹码
    }
    """
    pass

def save_user_data(user_hash: str, data: dict) -> None:
    """保存玩家数据"""
    pass

def update_user_chips(user_hash: str, current_chips: int) -> None:
    """更新玩家筹码数据
    - 如果 current_chips < 10，重置为1000
    - 否则更新 default_chips 为当前值
    """
    pass

def get_user_default_chips(user_hash: str) -> int:
    """获取玩家默认入局筹码
    如果玩家不存在，返回默认值1000
    """
    pass
```

### 3.2 牌堆管理

```python
RANKS = '23456789TJQKA'  # 牌面
SUITS = 'SHDC'            # 花色（Spades/Hearts/Diamonds/Clubs）

def new_deck(num_decks: int = 4) -> List[str]:
    """创建新牌堆（默认四副牌，共208张）"""
    pass

def shuffle_deck(deck: List[str]) -> None:
    """洗牌"""
    pass

def card_to_text(card: str) -> str:
    """将牌转换为文本显示（如 [♠A]）"""
    pass

def cards_to_text(cards: List[str]) -> str:
    """将多张牌转换为文本"""
    pass

def card_rank_value(card: str) -> int:
    """获取牌的数值（用于21+3判断）
    A=1, 2-10=2-10, J/Q/K=11/12/13
    """
    pass

def card_suit(card: str) -> str:
    """获取牌的花色"""
    pass
```

### 3.3 点数计算

```python
def get_card_value(card: str, ace_as_eleven: bool = True) -> int:
    """获取单张牌的点数
    - A: 1 或 11（由ace_as_eleven决定）
    - J/Q/K: 10
    - 其他: 牌面值
    """
    pass

def calculate_hand_value(cards: List[str]) -> Tuple[int, int, int]:
    """计算手牌点数
    返回: (hand_value, soft_value, hard_value)
    - hand_value: 最终点数（自动处理A的1/11选择）
    - soft_value: 软点数（A按11）
    - hard_value: 硬点数（A按1）
    """
    pass

def is_blackjack(cards: List[str]) -> bool:
    """判断是否为21点（A+10/J/Q/K）"""
    pass

def is_bust(value: int) -> bool:
    """判断是否爆牌（超过21）"""
    pass
```

### 3.4 游戏流程

```python
def reset_for_new_round(game: dict) -> None:
    """重置新一局游戏"""
    pass

def deal_initial_cards(game: dict) -> None:
    """发初始牌（每个玩家2张，庄家2张但最后一张暗牌）"""
    pass

def deal_card(game: dict, target: str, seat_id: int = None) -> Optional[str]:
    """发一张牌
    target: 'dealer' 或 'player'
    seat_id: 如果是玩家，指定座位号
    """
    pass

def apply_hit(game: dict, seat_id: int) -> Tuple[bool, str]:
    """要牌
    返回: (success, reason)
    """
    pass

def apply_stand(game: dict, seat_id: int) -> Tuple[bool, str]:
    """停牌"""
    pass

def apply_double_down(game: dict, seat_id: int) -> Tuple[bool, str]:
    """双倍下注（要一张牌后自动停牌）"""
    pass

def apply_split(game: dict, seat_id: int) -> Tuple[bool, str]:
    """分牌（将一对分拆成两手）"""
    pass

def apply_surrender(game: dict, seat_id: int) -> Tuple[bool, str]:
    """投降（收回一半下注）"""
    pass

def apply_insurance(game: dict, seat_id: int, amount: int) -> Tuple[bool, str]:
    """购买保险（当庄家明牌为A时）
    保险金额为原下注的一半
    返回: (success, reason)
    """
    pass

def check_21_3(dealer_first_card: str, player_first_two: List[str]) -> Tuple[bool, str, int]:
    """检查21+3牌型
    返回: (is_match, type_name, multiplier)
    type_name: 'straight'/'flush'/'three_kind'/'straight_flush'/'flush_three'
    multiplier: 倍率（10/5/25/25/50）
    """
    pass

def is_straight_21_3(cards: List[str]) -> bool:
    """判断是否为顺（三张牌连号）"""
    pass

def is_flush_21_3(cards: List[str]) -> bool:
    """判断是否为同花（三张牌同花色）"""
    pass

def is_three_kind_21_3(cards: List[str]) -> bool:
    """判断是否为三条（三张牌相同点数）"""
    pass
```

### 3.5 庄家行动

```python
def dealer_play(game: dict) -> None:
    """庄家要牌（遵循规则）
    庄家必须遵循固定规则：
    - 17点以下：必须要牌
    - 17点及以上：必须停牌
    - 软17（A+6）：可自由选择要牌或停牌（由庄家玩家决定）
    """
    pass

def dealer_can_hit(game: dict) -> bool:
    """判断庄家是否必须要牌
    返回True表示必须继续要牌，False表示可以停牌
    """
    pass
```

### 3.6 结算

```python
def settle_round(game: dict) -> dict:
    """结算本局
    返回结算结果：
    {
        'type': 'round_end',
        'dealer_cards': [...],
        'dealer_value': 17,
        'dealer_status': 'stand',  # stand/bust/blackjack
        'dealer_first_card': 'SA',  # 庄家第一张牌（用于21+3）
        'insurance_results': [      # 保险结算（庄家翻牌后立即结算）
            {
                'seat_id': 1,
                'insurance_bet': 50,
                'won': True,
                'payout': 100,
            },
            ...
        ],
        'results': [
            {
                'seat_id': 1,
                'hand_cards': [...],
                'hand_value': 20,
                'status': 'stand',
                'bet': 100,           # 主注
                'result': 'win',      # win/lose/push（平局）
                'payout': 200,        # 主注赢得的筹码
                'bet_21_3': 10,       # 21+3投注额
                'bet_21_3_type': 'straight',  # 21+3投注类型
                '21_3_result': {      # 21+3结算结果
                    'matched': True,
                    'type': 'straight',
                    'multiplier': 10,
                    'payout': 100,
                },
            },
            ...
        ],
        'refunds': [],  # 投降退款
    }
    """
    pass

def settle_insurance(game: dict) -> List[dict]:
    """结算保险（庄家翻牌后立即调用）
    返回保险结算结果列表
    """
    pass

def settle_21_3(dealer_first_card: str, player_hand: List[str], bet_type: str, bet_amount: int) -> dict:
    """结算21+3投注
    返回: {
        'matched': bool,
        'type': str,  # 匹配的牌型
        'multiplier': int,  # 倍率
        'payout': int,  # 赔付金额
    }
    """
    pass
```

### 3.7 工具函数

```python
def find_player(players: List[dict], seat_id: int) -> Optional[dict]:
    """查找玩家"""
    pass

def get_nickname(plugin_event, user_id: str, tmp_hagID: Optional[str], ...) -> str:
    """获取玩家昵称（优先级：自定义昵称 > 人物卡 > QQ昵称）"""
    pass

def set_user_nickname(bot_hash: str, group_hash: str, user_id: str, nickname: str) -> None:
    """设置用户自定义昵称"""
    pass

def qq_is_friend(plugin_event, user_id: str) -> bool:
    """QQ平台检查是否为好友（用于私聊发牌）"""
    pass

def sendMsgByEvent(plugin_event, message, target_id, target_type, host_id=None):
    """发送消息（群聊/私聊）"""
    pass
```

---

## 四、命令设计（msgReply.py）

### 4.1 建局/入场命令

| 命令 | 别名 | 说明 | 参数 |
|------|------|------|------|
| `.bj 创建 [底注] [模式]` | `.21 创建` | 创建游戏房间 | 底注默认100，必须>=10；模式：明牌/手持（默认明牌） |
| `.bj 加入 [名称] [筹码]` | `.21 加入` | 加入游戏 | 筹码默认1000，必须>=底注；第一个加入的玩家为庄家 |
| `.bj 退出` | `.21 退出` | 退出游戏（仅开局前） | 无 |
| `.bj 解散` | `.21 解散` | 解散房间（仅开局前） | 权限：座位1/管理员/群主/骰主 |
| `.bj 开始` | `.21 开始` | 开始游戏 | 至少1人，最多10人（庄家不占座位） |

### 4.2 下注命令

| 命令 | 别名 | 说明 | 参数 |
|------|------|------|------|
| `.bj 下注 [金额] [21+3类型] [21+3金额]` | `.21 下` | 下注（可同时下21+3注） | 主注金额必须>=最小下注且<=最大下注；21+3类型：顺/同花/三条/同花顺/同花三条 |
| `.bj 加注 [金额]` | `.21 加` | 增加下注（必须在已下注的基础上） | 金额为增加额 |
| `.bj 保险 [金额]` | `.21 保险` | 购买保险（仅庄家明牌为A时） | 金额默认为主注的一半，不能超过主注的一半 |

### 4.3 游戏行动命令（仅轮到你时）

| 命令 | 别名 | 说明 | 条件 |
|------|------|------|------|
| `.bj 要` | `.21 要`、`.bj hit` | 要一张牌 | 未停牌/未爆牌时 |
| `.bj 停` | `.21 停`、`.bj stand` | 停牌 | 未停牌时 |
| `.bj 双倍` | `.21 双倍`、`.bj double` | 双倍下注（要一张牌后停牌） | 仅第一张牌后可用 |
| `.bj 分牌` | `.21 分`、`.bj split` | 分牌（将一对分拆） | 两张牌且点数相同 |
| `.bj 投降` | `.21 投降`、`.bj surrender` | 投降（收回一半下注） | 仅第一次行动可用 |
| `.bj 保险 [金额]` | `.21 保险` | 购买保险 | 仅庄家明牌为A时可用 |

**注意**：庄家（第一个加入的玩家）在软17时可以选择要牌或停牌，系统会提示但不会强制。

### 4.4 查看命令

| 命令 | 别名 | 说明 |
|------|------|------|
| `.bj 看牌` | `.21 看牌`、`.bj cards` | 私聊查看自己的手牌 |
| `.bj 局势` | `.21 局势`、`.bj status` | 查看当前游戏局势 |
| `.bj 列表` | `.21 列表`、`.bj list` | 查看玩家列表 |

### 4.5 筹码管理命令

| 命令 | 别名 | 说明 | 参数 |
|------|------|------|------|
| `.bj 设置筹码 [金额]` | `.21 设置筹码`、`.bj setchips` | 设置默认入局筹码 | 金额必须>=10，用于下次入局时使用。 |
| `.bj 我的筹码` | `.21 我的筹码`、`.bj mychips` | 查看自己的默认入局筹码 | 无 |

**说明**：
- `设置筹码`：随时可以修改，会保存到玩家数据文件
- 设置的筹码作为默认入局筹码，下次加入游戏时使用
- 游戏结算后，如果当前筹码高于历史最高记录，会自动更新最高筹码

### 4.6 管理命令

| 命令 | 别名 | 说明 | 权限 |
|------|------|------|------|
| `.bj 强制结束` | `.bj stop`、`.bj halt` | 强制结束并销毁数据 | 管理员/群主/骰主 |

---

## 五、游戏规则说明

### 5.1 基本规则

1. **目标**：手牌点数尽可能接近21点但不超过，且比庄家大
2. **点数计算**：
   - A = 1 或 11（自动选择最优值）
   - J/Q/K = 10
   - 其他牌 = 牌面值
3. **21点（Blackjack）**：首两张牌为A+10/J/Q/K，赔率1.5倍
4. **爆牌（Bust）**：超过21点立即输

### 5.2 玩家行动选项

1. **要牌（Hit）**：再要一张牌
2. **停牌（Stand）**：不再要牌
3. **双倍下注（Double Down）**：
   - 仅第一张牌后可用
   - 下注翻倍，只能再要一张牌后自动停牌
4. **分牌（Split）**：
   - 仅手牌为两张且点数相同时可用
   - 将手牌分成两手，每手独立游戏
   - 需要额外下注（与原始下注相同）
5. **投降（Surrender）**：
   - 仅第一次行动可用
   - 收回一半下注，退出本局

### 5.3 庄家规则

- **第一个加入的玩家为庄家**：庄家由第一个加入游戏的玩家担任
- 庄家必须遵循固定规则：
  - 17点以下：必须要牌
  - 17点及以上：必须停牌
  - 软17（A+6）：可自由选择要牌或停牌（由庄家玩家决定，系统只给提示）
- 庄家与每个玩家独立对战

### 5.4 结算规则

1. **玩家21点**：如果庄家不是21点，玩家赢得1.5倍下注
2. **玩家胜**：点数大于庄家（且未爆牌），赢得1倍下注
3. **玩家负**：点数小于庄家或爆牌，输掉下注
4. **平局（Push）**：点数相同，返还下注
5. **庄家爆牌**：所有未爆牌玩家获胜

### 5.5 分牌规则

- 分牌后每手独立游戏
- 如果分牌后又拿到相同点数（如AA分牌后再拿A），可以再次分牌
- 分牌后不能双倍下注（部分规则允许，本插件默认不允许）

### 5.6 21+3投注规则

21+3是一种边注，与主注同时下注。使用**庄家第一张牌**和**玩家前两张牌**组成三张牌，判断牌型：

1. **顺（Straight）**：三张牌点数连号，赔率**10倍**
   - 示例：5-6-7、9-10-J、A-2-3、J-Q-K
   - A可以作为1或14使用
   - 点数顺序：A(1/14), 2, 3, 4, 5, 6, 7, 8, 9, 10, J(11), Q(12), K(13)

2. **同花（Flush）**：三张牌花色相同（不需要连号），赔率**5倍**
   - 示例：♠5-♠9-♠K、♥2-♥7-♥Q

3. **三条（Three of a Kind）**：三张牌点数相同，赔率**25倍**
   - 示例：5-5-5、K-K-K、A-A-A

4. **同花顺（Straight Flush）**：三张牌花色相同且连号，赔率**25倍**
   - 示例：♠5-♠6-♠7、♥J-♥Q-♥K

5. **同花三条（Flush Three）**：三张牌花色相同且点数相同，赔率**50倍**（最高）
   - 示例：♠5-♠5-♠5、♥K-♥K-♥K

**投注方式**：
- 在下注主注时，可以同时指定21+3投注类型和金额
- 格式：`.bj 下注 [主注金额] [21+3类型] [21+3金额]`
- 示例：`.bj 下注 100 顺 20` （主注100，21+3投注顺20）

**结算规则**：
- 21+3投注与21点主注**独立结算**
- 如果同时满足21点和21+3条件，**两者可以同时获得奖励**
- 如果匹配投注的牌型：按对应倍率赔付
- 如果不匹配：21+3投注金额没收
- 结算时机：在庄家行动完成后，与主注一起结算

### 5.7 保险规则

**触发条件**：
- 庄家明牌（第一张牌）为A时，所有玩家可以选择购买保险
- 保险必须在玩家第一次行动前购买

**保险金额**：
- 默认为主注的一半
- 可以自定义金额，但不能超过主注的一半
- 格式：`.bj 保险 [金额]` 或 `.bj 保险`（使用默认值）

**结算规则**：
- **结算时机**：庄家翻开暗牌后**立即结算**，不等待主注结算
- 如果庄家前两张牌总和为21点（Blackjack）：玩家获得保险金额的**2倍赔偿**
  - 示例：保险50，庄家21点，获得100赔付
- 如果庄家不是21点：保险金立即没收

**重要说明**：
- **保险不影响主注**：无论保险输赢，主注的正常结算继续进行
- 即使玩家购买保险，主注仍然按照正常规则与庄家比较
- 如果庄家21点且玩家也21点：保险赔付 + 主注平局
- 如果庄家21点且玩家不是21点：保险赔付 + 主注输掉

### 5.8 明牌局与手持局

创建游戏时可以选择两种模式：

1. **明牌局（open）**：
   - 玩家手牌在群内公开显示
   - 只有庄家发暗牌（第二张）
   - 自动检测玩家的21点

2. **手持局（hidden）**：
   - 玩家的两张手牌都是暗牌（私聊发送）
   - 庄家第二张牌也是暗牌
   - **不自动检测21点**，让玩家自由选择停牌或继续要牌
   - 群内只显示玩家手牌数量和点数总和（如 "2张牌 15点"）

---

## 六、消息模板设计（msgCustom.py）此处的消息模板仅为初始消息模板，请根据实际情况进行修改。

### 6.1 错误提示

```python
dictStrCustom = {
    'strBJErrNotInGroup': '该指令仅支持在群聊中使用。',
    'strBJErrRoomNotFound': '本群未建局，请先使用：.bj 创建 [底注]（默认100）。',
    'strBJErrAlreadyPlaying': '游戏已开始，无法进行该操作。',
    'strBJErrNotPlaying': '当前未在进行21点游戏。',
    'strBJErrNoPermission': '权限不足，无法执行该操作。',
    'strBJErrInvalidNumber': '参数错误：请输入合法数字。',
    'strBJErrInvalidSeat': '座位号无效。',
    'strBJErrNotYourTurn': '现在不是你的回合。',
    'strBJErrNotEnoughChips': '筹码不足。',
    'strBJErrBetTooSmall': '下注金额过小，最小下注为[{tMinStake}]。',
    'strBJErrBetTooLarge': '下注金额过大，最大下注为[{tMaxStake}]。',
    'strBJErrActionNotAllowed': '当前无法执行该操作。',
    'strBJErrCannotDouble': '无法双倍下注（仅第一张牌后可用）。',
    'strBJErrCannotSplit': '无法分牌（手牌必须为两张且点数相同）。',
    'strBJErrCannotSurrender': '无法投降（仅第一次行动可用）。',
    'strBJErrCannotInsurance': '无法购买保险（仅庄家明牌为A时可用）。',
    'strBJErrInsuranceTooLarge': '保险金额不能超过主注的一半。',
    'strBJErrInvalid21_3Type': '21+3类型无效，请选择：顺/同花/三条/同花顺/同花三条。',
    'strBJErrSetChipsInvalid': '设置的筹码金额无效，必须>=10。',
}
```

### 6.2 建局/入场消息

```python
'strBJCreateSuccess': '已创建21点房间，基础下注[{tBaseStake}]，最小下注[{tMinStake}]，最大下注[{tMaxStake}]，模式：{tGameMode}。\n使用 .bj 加入 [人物名] [筹码] 加入游戏（第一个加入的玩家为庄家）。',
'strBJJoinSuccess': '玩家[{tName}]加入游戏：<座位{tSeatId}>，携带筹码 {tChips}{tIsDealer}。',
'strBJJoinAsDealer': '（庄家）',
'strBJQuitSuccess': '玩家[{tName}]已退出：<座位{tSeatId}>。',
'strBJDismissSuccess': '房间已解散。',
'strBJStartSuccess': '游戏开始！已发牌。\n请使用[.bj 下注]进行下注（可同时下21+3注），然后使用[.bj 看牌]查看手牌（将通过私聊发送）\n{tAtAll}',
```

### 6.3 游戏状态面板

```python
'strBJStatusHeader': '底注: {tBaseStake} ‖ 最小下注: {tMinStake} ‖ 最大下注: {tMaxStake} ‖ 模式: {tGameMode}',
'strBJStatusDealer': '庄家[{tDealerName}]手牌: {tDealerCards}（点数: {tDealerValue}）',
'strBJStatusSeparator': '------------------------------',
'strBJStatusSeatLine1': '座位{tSeatId}: {tSeatName}',
'strBJStatusSeatLine2': '筹码: {tSeatChips} ‖ 主注: {tSeatBet} ‖ 保险: {tInsuranceBet} ‖ 21+3: {t21_3Bet} ‖ {tSeatStatus}',
'strBJStatusTurnLine': '轮到[<座位{tTurnSeatId}>{tTurnName}]{tTurnAt}行动',
'strBJStatusCmdHint': '指令: {tCmdHint}',
'strBJStatusBoard': '{tHeader}\n{tDealer}\n{tSep}\n{tSeatLines}\n{tSep}\n{tTurnLine}\n{tSep}\n{tCmdLine}',
```

### 6.4 行动反馈

```python
'strBJHitSuccess': '[<座位{tSeatId}>{tSeatName}]要牌：{tNewCard}，当前点数：{tHandValue}',
'strBJStandSuccess': '[<座位{tSeatId}>{tSeatName}]停牌，最终点数：{tHandValue}',
'strBJDoubleSuccess': '[<座位{tSeatId}>{tSeatName}]双倍下注：{tNewCard}，最终点数：{tHandValue}',
'strBJSplitSuccess': '[<座位{tSeatId}>{tSeatName}]分牌：第一手{tHand1Cards}，第二手{tHand2Cards}',
'strBJSurrenderSuccess': '[<座位{tSeatId}>{tSeatName}]投降，收回一半下注：{tRefund}',
'strBJInsuranceSuccess': '[<座位{tSeatId}>{tSeatName}]购买保险：{tInsuranceAmount}',
'strBJInsuranceWin': '[<座位{tSeatId}>{tSeatName}]保险赔付：{tPayout}（庄家21点）',
'strBJInsuranceLose': '[<座位{tSeatId}>{tSeatName}]保险失效（庄家不是21点）',
'strBJ21_3Win': '[<座位{tSeatId}>{tSeatName}]21+3中奖：{tType}（{tMultiplier}倍），获得{tPayout}',
'strBJBust': '[<座位{tSeatId}>{tSeatName}]爆牌（点数：{tHandValue}）',
'strBJBlackjack': '[<座位{tSeatId}>{tSeatName}]21点！',
```

### 6.5 结算消息

```python
'strBJRoundEndHeader': '本局结束：',
'strBJRoundDealerCards': '庄家手牌: {tDealerCards}，点数：{tDealerValue}',
'strBJRoundResultLine': '[<座位{tSeatId}>{tSeatName}] 手牌:{tHandCards} 点数:{tHandValue} {tResultText} {tPayout}',
'strBJRound21_3Result': '[<座位{tSeatId}>{tSeatName}] 21+3: {t21_3Result}',
'strBJRoundInsuranceResult': '[<座位{tSeatId}>{tSeatName}] 保险: {tInsuranceResult}',
'strBJResultWin': '获胜',
'strBJResultLose': '失败',
'strBJResultPush': '平局',
'strBJResultBlackjack': '21点（1.5倍）',
'strBJResultBust': '爆牌',
```

### 6.6 私聊看牌

```python
'strBJPrivateCardsHeader': '来自群: [{tGroupId}]',
'strBJPrivateCardsSeatLine': '座位: {tSeatId}号 - {tSeatName}',
'strBJPrivateCardsCardsLine': '手牌: {tHandCards}',
'strBJPrivateCardsValueLine': '点数: {tHandValue}',
'strBJPrivateCardsFooter': '请在群内进行操作。',

### 6.7 筹码管理消息

```python
'strBJSetChipsSuccess': '已设置默认入局筹码为 {tChips}。下次加入游戏时将使用此筹码。',
'strBJMyChipsInfo': '你的筹码信息：\n默认入局筹码：{tDefaultChips}',
'strBJChipsReset': '你的筹码低于10，已重置为1000。',
```

---

## 七、核心流程设计

### 7.1 游戏开始流程

```
1. 用户执行 .bj 创建 [底注]
   → 创建房间，设置底注/最小下注/最大下注
   → state = 'waiting'

2. 用户执行 .bj 加入 [名称] [筹码]
   → 如果是第一个加入的玩家，标记为庄家（dealer_seat_id）
   → 分配座位（1-10，庄家不占座位）
   → 获取玩家user_hash
   → 加载玩家数据文件：
      - 如果文件不存在，使用默认值1000
      - 如果指定了筹码参数，使用指定的筹码
      - 否则使用玩家数据文件中的default_chips
   → 初始化玩家数据（包括筹码）
   → 记录加入顺序

3. 用户执行 .bj 开始
   → 检查玩家数量（至少1人，最多10人，不包括庄家）
   → state = 'playing'
   → 重置牌堆并洗牌（四副牌，共208张）
   → 发初始牌：
      - 明牌局：玩家2张（公开），庄家2张（第二张暗牌）
      - 手持局：玩家2张（暗牌），庄家2张（第二张暗牌）
   → 私聊发送每个玩家的手牌（手持局，明牌局闲家不发）
   → 检查庄家明牌是否为A（触发保险选项）
   → 如果明牌局且玩家有天然21点，自动标记
   → 显示局势面板，等待玩家下注
```

### 7.2 玩家行动流程

```
1. 轮到玩家行动（显示局势面板）
   → 显示庄家明牌（第一张，第二张显示为[??]）
   → 显示所有玩家：
      - 明牌局：显示手牌和点数
      - 手持局：显示手牌数量（如"2张牌"）和点数，不显示具体手牌
   → 显示每个玩家的主注、保险、21+3投注
   → 发送私聊：庄家的暗牌、玩家的暗牌（手持局）

2. 玩家可以选择：
   a) .bj 要牌
      → 发一张牌
      → 计算点数
      → 如果爆牌：标记bust，自动停牌
      → 如果是21点：标记blackjack，自动停牌
      → 更新局势面板
   
   b) .bj 停牌
      → 标记stand
      → 切换到下一个玩家
   
   c) .bj 双倍下注（仅第一张牌后）
      → 下注翻倍
      → 发一张牌
      → 自动停牌
      → 切换到下一个玩家
   
   d) .bj 分牌（两张相同点数）
      → 创建两个手牌
      → 每手各发一张牌
      → 需要额外下注
      → 分别进行游戏
   
   e) .bj 投降（仅第一次行动）
      → 收回一半下注
      → 标记退出本局
   
   f) .bj 保险 [金额]（仅庄家明牌为A时）
      → 支付保险金（主注的一半）
      → 等待庄家翻牌
      → 如果庄家21点，获得2倍保险赔偿

2. 下注阶段：
   → 玩家可以使用 .bj 下注 [金额] [21+3类型] [21+3金额]
   → 同时下主注和21+3边注
   → 如果庄家明牌为A，提示可以购买保险

3. 所有玩家行动完成后
   → 庄家翻开暗牌
   → 结算保险（如果购买了）
   → 庄家行动（庄家玩家控制，系统提示规则）
   → 结算主注和21+3
   → 显示结算结果
   → 重置或继续下一局
```

### 7.3 庄家行动流程

```
1. 所有玩家行动完成后
2. 翻开庄家暗牌
3. 显示庄家完整手牌和点数
4. 结算保险（如果玩家购买了）：
   - 如果庄家21点：赔付保险（2倍）
   - 如果庄家不是21点：没收保险
5. 庄家行动（由庄家玩家控制）：
   - 系统提示：如果点数 < 17，提示"必须继续要牌"
   - 系统提示：如果点数 >= 17，提示"可以停牌"
   - 系统提示：如果软17，提示"软17，可选择要牌或停牌"
   - 庄家玩家使用 .bj 要 或 .bj 停 进行操作
6. 重复步骤5直到停牌或爆牌
```

### 7.4 结算流程

```
1. 结算保险（庄家翻开暗牌后立即结算）
   a) 如果庄家21点：每个购买保险的玩家获得保险金额的2倍
   b) 如果庄家不是21点：保险金没收

2. 结算21+3投注（与主注独立）
   a) 使用庄家第一张牌和玩家前两张牌组成三张牌
   b) 判断牌型：顺/同花/三条/同花顺/同花三条
   c) 如果匹配投注类型：按倍率赔付（10/5/25/25/50倍）
   d) 如果不匹配：21+3投注没收

3. 结算主注（21点）
   a) 如果玩家已投降：退还一半下注（已在投降时处理）
   b) 如果玩家爆牌：输掉主注
   c) 如果玩家21点：
      - 如果庄家也是21点：平局
      - 否则：玩家赢得1.5倍主注
   d) 如果玩家未爆牌：
      - 如果庄家爆牌：玩家获胜（1倍）
      - 如果玩家点数 > 庄家点数：玩家获胜（1倍）
      - 如果玩家点数 < 庄家点数：玩家失败
      - 如果玩家点数 = 庄家点数：平局

4. 更新玩家筹码（主注 + 保险 + 21+3）
5. **更新玩家数据文件**（针对所有参与的玩家）：
   a) 获取玩家user_hash
   b) 加载玩家数据文件
   c) 检查当前筹码：
      - 如果当前筹码 < 10：重置为1000，提示玩家
      - 否则：更新default_chips为当前筹码值
   d) 保存玩家数据文件
6. 显示结算结果（分别显示主注、保险、21+3的结算）
7. 检查是否有玩家破产
8. 继续下一局或结束游戏
```

---

## 八、实现细节

### 8.1 发牌逻辑

- 使用四副标准牌堆（共208张牌）
- 每局开始洗牌
- 发牌顺序：玩家1（第一张）→ 玩家2（第一张）→ ... → 庄家（第一张）→ 玩家1（第二张）→ ... → 庄家（第二张，暗牌）
- 庄家第二张牌作为暗牌，所有玩家行动完成后才翻开

### 8.2 点数计算细节

- A的处理：优先按11计算，如果超过21则按1计算
- 软点数：至少一张A按11计算的值
- 硬点数：所有A按1计算的值
- 最终点数：选择不超过21的最大值
- 点数显示格式：
  - 如果有软点数且不超过21：显示为 "软点数/硬点数"（如 "7/18"）
  - 如果软点数超过21：只显示硬点数（如 "18"）
  - 如果只有硬点数：只显示一个数字（如 "15"）

### 8.6 21+3牌型判断

- **顺（Straight）**：
  - 三张牌点数连号（如 5-6-7）
  - A可以作为1或14（A-2-3 或 J-Q-K）
  - 使用card_rank_value获取点数进行比较

- **同花（Flush）**：
  - 三张牌花色相同
  - 使用card_suit获取花色进行比较

- **三条（Three of a Kind）**：
  - 三张牌点数相同
  - 使用card_rank_value比较

- **同花顺（Straight Flush）**：
  - 同时满足顺和同花的条件
  - 倍率25倍（不是两者叠加）

- **同花三条（Flush Three）**：
  - 同时满足同花和三条的条件
  - 倍率50倍（最高倍率）

### 8.7 保险判断

- 触发条件：庄家第一张牌（明牌）为A
- 判断时机：发完初始牌后立即检查
- 保险金额：默认为主注的一半，可以自定义（但不能超过主注的一半）
- 结算时机：庄家翻开暗牌后立即结算，不等待主注结算

### 8.8 明牌局与手持局差异

**明牌局（open）**：
- 玩家手牌在群内显示完整信息（牌面和点数）
- 只有庄家第二张牌是暗牌
- 自动检测21点并标记
- 私聊只发送提醒信息

**手持局（hidden）**：
- 玩家手牌不在群内显示具体内容
- 群内只显示：手牌数量（如"2张牌"）和点数
- 庄家第二张牌也是暗牌
- **不自动检测21点**，让玩家自由决定是否继续
- 私聊显示完整手牌信息

### 8.3 分牌处理

- 分牌后，玩家拥有多手牌（split_hands数组）
- 每手独立进行游戏
- 轮到时需要指定操作哪一手（或按顺序）
- 结算时分别结算每手

### 8.4 庄家暗牌

- 初始发牌时，庄家第二张牌作为暗牌
- 在msgReply中显示时，暗牌显示为 [??]
- 所有玩家行动完成后才翻开暗牌

### 8.5 私聊发牌

- 使用sendMsgByEvent发送私聊
- QQ平台需要先加好友验证（qq_is_friend）
- 私聊消息包含：群组信息、座位号、手牌、点数

---

## 九、特殊规则处理

### 9.1 多人游戏

- 最多10人同时游戏
- 每个玩家独立与庄家对战
- 玩家之间不互相影响

### 9.2 筹码管理

**玩家筹码数据存储**：
- 每个玩家的筹码数据存储在独立的用户文件中：`plugin/data/BlackJack/user/{user_hash}.json`
- 数据结构：
  ```json
  {
    "default_chips": 1000  // 默认入局筹码
  }
  ```

**筹码管理规则**：
1. **默认入局筹码**：
   - 首次加入游戏时，如果没有记录，默认使用1000筹码
   - 玩家可以使用 `.bj 设置筹码 [金额]` 随时修改默认入局筹码
   - 修改后的筹码会保存到玩家数据文件，下次加入游戏时使用

2. **加入游戏时**：
   - 使用玩家数据文件中的 `default_chips` 作为初始筹码
   - 如果文件不存在，默认使用1000
   - 如果指定了筹码参数，使用指定的筹码

3. **游戏过程中**：
   - 每局下注从筹码扣除
   - 结算时增加/减少筹码
   - 筹码为0时标记为out，下一局开始时移除

4. **结算后更新**：
   - 每局结算后，检查玩家当前筹码
   - **如果当前筹码 < 10，重置为1000并提示玩家**
   - 否则更新 `default_chips` 为当前筹码值
   - 保存到玩家数据文件

**筹码重置规则**：
- 任何时候，如果玩家的筹码小于10，系统会自动重置为1000
- 重置发生在结算后更新玩家数据时
- 重置后会提示玩家："你的筹码低于10，已重置为1000。"

### 9.3 破产处理

- 筹码为0时标记为out
- out的玩家不再参与游戏
- 可以重新加入（如果房间允许）

---

## 十、与TexasHoldem的对应关系

| TexasHoldem | 21点 | 说明 |
|-------------|------|------|
| 德州扑克 | 21点 | 游戏类型 |
| 底注/盲注 | 基础下注/最小下注 | 下注机制 |
| 翻牌前/翻牌/转牌/河牌 | 下注阶段/要牌阶段 | 游戏阶段 |
| 公共牌 | 庄家手牌 | 共享信息 |
| 底牌（私聊） | 手牌（私聊） | 私有信息 |
| 弃牌/跟注/加注 | 要牌/停牌/双倍/分牌 | 行动选项 |
| 摊牌结算 | 点数比较结算 | 结算方式 |

---

## 十一、开发检查清单

### 11.1 数据结构
- [ ] 游戏状态数据（blackjack_default）
- [ ] 玩家数据结构
- [ ] 结算结果数据结构

### 11.2 核心函数
- [ ] 数据持久化（load/save，群组数据和玩家数据分离）
- [ ] 玩家数据管理（load_user_data/save_user_data/update_user_chips/get_user_default_chips）
- [ ] 牌堆管理（new_deck/shuffle，四副牌）
- [ ] 点数计算（calculate_hand_value，支持软/硬点数显示）
- [ ] 游戏流程（deal/reset/settle）
- [ ] 玩家行动（hit/stand/double/split/surrender/insurance）
- [ ] 庄家行动（dealer_play，软17提示）
- [ ] 21+3判断（check_21_3，is_straight_21_3等）
- [ ] 保险结算（settle_insurance）
- [ ] 21+3结算（settle_21_3）
- [ ] 筹码更新（结算后更新玩家数据文件）

### 11.3 命令处理
- [ ] 建局命令（创建[含模式选择]/加入[第一个为庄家]/退出/解散/开始）
- [ ] 下注命令（下注[含21+3]/加注/保险）
- [ ] 行动命令（要/停/双倍/分牌/投降/保险）
- [ ] 查看命令（看牌/局势/列表）
- [ ] 筹码管理命令（设置筹码/我的筹码）
- [ ] 管理命令（强制结束）

### 11.4 消息模板
- [ ] 错误提示
- [ ] 建局/入场消息
- [ ] 游戏状态面板
- [ ] 行动反馈
- [ ] 结算消息
- [ ] 私聊看牌

### 11.5 特殊功能
- [ ] 私聊发牌（QQ好友验证）
- [ ] 分牌处理（多手牌）
- [ ] 庄家行动（软17提示，由玩家控制）
- [ ] 21点检测（明牌局自动，手持局不自动）
- [ ] 爆牌检测
- [ ] 筹码管理（主注+保险+21+3）
- [ ] 玩家筹码数据持久化（用户文件独立存储）
- [ ] 结算后更新玩家筹码数据
- [ ] 筹码小于10时自动重置为1000
- [ ] 设置默认筹码命令
- [ ] 破产处理
- [ ] 明牌局/手持局模式支持
- [ ] 第一个玩家为庄家
- [ ] 21+3投注判断和结算
- [ ] 保险购买和结算
- [ ] 软/硬点数显示（7/18格式）

---

## 十二、测试要点

### 12.1 基本功能
- [ ] 创建房间、加入、开始游戏
- [ ] 下注、要牌、停牌
- [ ] 双倍下注
- [ ] 分牌
- [ ] 投降
- [ ] 庄家自动行动
- [ ] 结算正确性

### 12.2 边界情况
- [ ] A的点数计算（1/11，软/硬点数）
- [ ] 爆牌处理
- [ ] 21点处理（明牌局自动，手持局不自动）
- [ ] 分牌后再分牌
- [ ] 筹码不足（主注/保险/21+3）
- [ ] 多人游戏
- [ ] 庄家软17（提示但由玩家控制）
- [ ] 21+3所有牌型判断
- [ ] 保险触发（庄家明牌为A）
- [ ] 明牌局vs手持局显示差异
- [ ] 第一个玩家为庄家的处理
- [ ] 21+3与21点同时中奖
- [ ] 保险独立结算不影响主注
- [ ] 筹码数据持久化（玩家文件）
- [ ] 设置筹码命令（随时修改）
- [ ] 结算后更新筹码数据
- [ ] 筹码小于10时重置为1000

### 12.3 错误处理
- [ ] 无效命令
- [ ] 权限检查
- [ ] 状态检查（不是你的回合等）
- [ ] 参数验证

---

## 附录：命令快速参考

```
【建局/入场】
.bj 创建 [模式] [底注]     # 创建房间（模式：明牌/手持，默认明牌）没有模式默认手持
.bj 加入 [名称] [筹码]     # 加入游戏（第一个加入的为庄家）
.bj 退出                   # 退出（仅开局前）
.bj 开始                   # 开始游戏

【下注】
.bj 下注 [金额] [21+3类型] [21+3金额]  # 下主注和21+3边注
.bj 加注 [金额]                        # 增加主注
.bj 保险 [金额]                        # 购买保险（庄家明牌为A时）

【行动】
.bj 要                     # 要牌
.bj 停                     # 停牌
.bj 双倍                   # 双倍下注
.bj 分牌                   # 分牌
.bj 投降                   # 投降

【查看】
.bj 看牌                   # 私聊查看手牌
.bj 局势                   # 查看当前局势
.bj 列表                   # 查看玩家列表

【筹码管理】
.bj 设置筹码 [金额]        # 设置默认入局筹码（随时可用）
.bj 我的筹码               # 查看自己的筹码信息

【管理】
.bj 强制结束               # 强制结束（管理员）
```

## 附录：21+3投注类型说明

- **顺**：三张牌点数连号（如 5-6-7），10倍
- **同花**：三张牌花色相同，5倍
- **三条**：三张牌点数相同，25倍
- **同花顺**：三张牌花色相同且连号，25倍
- **同花三条**：三张牌花色相同且点数相同，50倍

## 附录：游戏模式说明

- **明牌局**：玩家手牌公开，自动检测21点
- **手持局**：玩家手牌暗牌，不自动检测21点，增加博弈感

---

## 注意事项

1. **私聊功能**：QQ平台需要先加bot为好友才能私聊发牌
2. **多人游戏**：最多支持10人同时游戏（不包括庄家）
3. **庄家设置**：第一个加入的玩家自动成为庄家，庄家不占座位
4. **游戏模式**：创建时选择明牌局或手持局，影响手牌显示和21点检测
5. **21+3投注**：与主注独立结算，可以同时中奖
6. **保险**：仅在庄家明牌为A时可用，独立于主注结算
7. **庄家规则**：软17时由庄家玩家自行决定，系统只给提示
8. **数据持久化**：
   - 群组数据：`plugin/data/BlackJack/group/{group_hash}.json`
   - 玩家数据：`plugin/data/BlackJack/user/{user_hash}.json`（独立存储）
9. **筹码管理**：玩家可以随时使用 `.bj 设置筹码 [金额]` 修改默认入局筹码
10. **筹码重置**：结算后如果筹码小于10，自动重置为1000
11. **牌堆**：使用四副牌（208张），增加真实感
12. **分牌限制**：部分规则可能不同，按标准规则实现

---

**文档版本**：v1.0.0  
**最后更新**：2026.1.10

