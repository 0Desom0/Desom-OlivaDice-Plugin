# QQGroupForward

- **名称**：`QQGroupForward`
- **作者**：`Desom-fu`
- **版本**：`1.2.0`
- **兼容版本**：`理论兼容所有 3.0 以上的 OlivOS 版本`
- **平台**：`理论支持全平台（仅在 QQ/OneBot 环境部署测试）`
- **前置插件**：`可选：OlivaDiceCore（用于骰主判定、人物卡显示、主从账号支持；未安装也可用但相关功能自动失效）`

---

## 注意

此插件为纯 AI 编程，但是确实可用，有 bug 我会修

---

## 简介

用于 QQ 多群“链接转发”的插件，支持：

- **单向链接**：在“本群”执行命令，把“对面群”的消息**单向转发到本群**（对面 → 本群）。
- **双向链接**：两边消息互相转发（A ↔ B）。
- **一对多 / 多对一**：一个群可连接多个群；多个群也可连接到同一个群（自动去重，禁止重复连接）。
- **分 bot 配置**：支持每个 bot 独立配置，主从账号自动识别（需 OlivaDiceCore）。
- **回复显示**：自动识别回复消息，显示被回复的内容上下文。
- **@显示优化**：将消息中的 @码自动转换为可读的 @名字形式。
- **无空格命令**：支持 `.群链双向123` 这样的无空格指令（兼容有空格指令）。
- **权限体系**：
  - 群链管理：群主 / 群管 / 骰主 / 配置 master
  - 双向链接额外限制：非骰主/配置 master 时，必须你在两边都是群主/管理员
  - 全局开关、人物卡开关：仅骰主

转发模板：

- 默认：

```text
[群昵称(群号) - 昵称(QQ号)]
消息内容
```

- 开启“人物卡显示”且检测到 OlivaDiceCore：

```text
[群昵称(群号) - 人物卡[昵称](QQ号)]
消息内容
```

- 包含回复时：

```text
[群昵称(群号) - 昵称(QQ号)]
↳ 回复 被回复人名: 被回复消息内容（可能截断）

当前消息内容
```

---

## 下载

- ### 插件包

`QQGroupForward.opk`

（论坛发布时可替换成你的上传链接/附件，比如：
`[upl-file uuid=... size=... ]QQGroupForward.opk[/upl-file]`
）

---

## 注意事项

- **对面群必须在 bot 的群列表里**：也就是 bot 必须已加入对面群（插件通过拉群成员列表验证）。
- **操作者本人也必须在对面群内**：否则不允许建立链接。
- **不会转发 bot 自己发送的消息**（避免回环）。
- **分 bot 配置**：不同 bot 的配置独立存储，主从账号（需要 OlivaDiceCore）会自动识别，从账号使用主账号的配置目录。
- 若未安装 `OlivaDiceCore`：
  - "骰主判定"、"人物卡显示"与"主从账号支持"会自动不可用（即便配置为开启也视为关闭）。
  - 但基础的群链转发、防刷、命令仍正常工作。
- **回复消息处理**：系统会自动识别并显示被回复消息的上下文；回复内容超过 100 字会被截断。
- **@ 显示**：转发时自动将 `[OP:at,...]` 或 `[CQ:at,...]` 码转换为 `@昵称` 形式，提高可读性。
- 转发内容会尽量按原消息文本转发（其他 OP/CQ 码也会原样带过去），不同平台/实现可能存在兼容差异。

---

## 命令总览（前缀：`.群链` / `。群链` / `/群链`）

### 链接管理

- `.群链 单向 [对面群号]`：建立单向（对面 → 本群）
- `.群链 双向 [对面群号]`：建立双向（A ↔ B）
- `.群链 断开 单向 [对面群号]`：断开单向（对面 → 本群）
- `.群链 断开 双向 [对面群号]`：断开双向（A ↔ B）
- `.群链 列表`：查看本群连接（会同时显示“接收”和“发送”两类连接）

### 防刷（去重）开关

- `.群链 防刷 开/关/状态`：开关“消息ID去重”（权限：骰主 / 配置 master）

### 全局转发开关（仅骰主）

- `.群链 全局 开/关/状态`：全局启用/禁用消息转发（命令仍可用，便于再开启）

### 人物卡显示（仅骰主，需 OlivaDiceCore）

- `.群链 人物卡 开/关/状态`：全局开关人物卡显示（默认开；无 OlivaDiceCore 时不可用）

### 转发过滤（默认关闭）

以下两项过滤在判断时会先“去掉消息开头连续出现的 @（AT 码或 @昵称）”，再判断前缀：

- `.群链 括号过滤 开/关/状态`：开启后，去除开头 AT 后若以 `(` 或 `（` 开头，则不转发
- `.群链 句号过滤 开/关/状态`：开启后，去除开头 AT 后若以 `.` 或 `。` 开头，则不转发（适合屏蔽指令类消息）

---

## 配置说明

配置文件（自动生成）：

- `plugin/data/QQGroupForward/default.json`

常用字段：

- `global_enabled`：全局转发总开关
- `pc_card_enabled`：人物卡显示开关（需 OlivaDiceCore）
- `dedup_enabled` / `dedup_ttl_sec`：防刷去重开关与 TTL
- `filter_skip_leading_bracket_after_at`：括号过滤开关（默认关）
- `filter_skip_leading_dot_after_at`：句号过滤开关（默认关）
- `masters`：配置 master 列表（权限等同骰主用于群链管理/防刷开关，但**不能**操作“全局/人物卡开关”）
- `edges`：路由表（有向边）：`src_group -> [dst_group, ...]`

---

## 使用示例

在“接收群”里执行：

```text
.群链 单向 123456789
```

含义：把 `123456789` 群的消息转发到当前群。

建立双向：

```text
.群链 双向 123456789
```

查看连接：

```text
.群链 列表
```

---

## 安装

1. 将 `QQGroupForward.opk` 放入 OlivOS 插件目录：`YourOlivOSPath/plugin/app`。
2. 重载插件。
3. 在需要接收转发的群里使用 `.群链 ...` 配置链接。

---

## 更新日志

### 2026.2.4 v1.2.0

- 新增两个“前缀不转发”开关（默认关闭）：
  - **括号过滤**：去除开头 AT 后以 `(` / `（` 开头的不转发
  - **句号过滤**：去除开头 AT 后以 `.` / `。` 开头的不转发

### 2026.2.1 v1.1.0

- **分 bot 配置**：支持每个 bot 独立配置，主从账号自动识别（需要 OlivaDiceCore）。
- **回复消息显示**：自动识别消息中的回复码，显示被回复消息的内容上下文。
- **@ 显示优化**：将 AT 消息自动转换为 `@昵称` 形式，提高转发内容的可读性。
- **无空格命令支持**：支持 `.群链双向123` 这样的无空格指令格式，兼容原有的空格指令。

### 2026.1.30 v1.0.0

- 初版发布：单向/双向群链、一对多/多对一、去重防刷、全局开关、人物卡显示（需 OlivaDiceCore）。

## 截图示例

![Image description](https://forum.olivos.run/assets/files/2026-01-30/1769765405-493287-c09de80c0bdf642f156fdecb92dbabc9.png)
![Image description](https://forum.olivos.run/assets/files/2026-01-30/1769765409-951587-473203d3e1049c8c19585c17be2a7175.png)

<!-- end -->